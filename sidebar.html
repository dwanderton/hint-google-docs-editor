<!DOCTYPE html>
<html>
  <head>
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-154880962-2"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-154880962-2');
    </script>

    <base target="_top">


    <!-- Libs CSS -->
    <link rel="stylesheet" href="https://hintwriting.com/assets/fonts/Feather/feather.css">
    <link rel="stylesheet" href="https://hintwriting.com/assets/libs/flickity/dist/flickity.min.css">
    <link rel="stylesheet" href="https://hintwriting.com/assets/libs/flickity-fade/flickity-fade.css">
    <link rel="stylesheet" href="https://hintwriting.com/assets/libs/aos/dist/aos.css">
    <link rel="stylesheet" href="https://hintwriting.com/assets/libs/jarallax/dist/jarallax.css">
    <link rel="stylesheet" href="https://hintwriting.com/assets/libs/highlightjs/styles/vs2015.css">
    <link rel="stylesheet" href="https://hintwriting.com/assets/libs/@fancyapps/fancybox/dist/jquery.fancybox.min.css">

    <!-- Theme CSS -->
    <link rel="stylesheet" href="https://hintwriting.com/assets/css/theme.min.css">
    <link rel="stylesheet" href="https://hintwriting.com/assets/css/custom.css">

    <style>
    /*
    * misc styles
    */
    #error-bay {
      display:none;
    }

    /*
    * typing styles
    */

    /* Cursor Styling */

    .cursor::after {
      content:'';
      display:inline-block;
      margin-left:3px;
      background-color:black;
      animation-name:blink;
      animation-duration:0.5s;
      animation-iteration-count: infinite;
    }
    h5.cursor::after {
      height:13px;
      width:6px;
    }
    p.cursor::after {
      height:13px;
      width:6px;
    }

    @keyframes blink {
      0% {
        opacity:1;
      }
      49% {
        opacity:1;
      }
      50% {
        opacity:0;
      }
      100% {
        opacity:0;
      }
    }
    </style>

  </head>
  <body>
  <div class="container" style="padding-top: 5%; padding-bottom: 5%;">
    <a class="navbar-brand" href="https://hintwriting.com" target="_blank">
      <img src="https://hintwriting.com/assets/img/brand.png" class="navbar-brand-img" alt="hint logo">
    </a>
    <br/><br/>
    <form>
      <div class="form-group">
        <div class="output" id="output">
          <p class="cursor"></p>
        </div>
        <!-- <textarea class="form-control is-valid"  rows="11" disabled></textarea> -->
      </div>
      <div class="block" id="button-bar">
        <button class="btn btn-outline-primary shadow lift mr-1" id="run-hint">
          Get a Hint
        </button>
        <button class="btn btn-outline-success shadow lift mr-1" id="insert-text">
          Insert Text
        </button>
      </div>
      <br/><br/>
      <div id="error-bay">
      </div>
    </form>
  </div>

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
    <script>
    /**
    * typing https://codepen.io/daviddcarr/pen/XVyQMM
    **/
    // values to keep track of the number of letters typed, which quote to use. etc. Don't change these values.
    var i = 0,
        a = 0,
        isBackspacing = false,
        isParagraph = false;

    // Speed (in milliseconds) of typing.
    var speedForward = 40, //Typing Speed
        speedWait = 1000, // Wait between typing and backspacing
        speedBetweenLines = 1000, //Wait between first and second lines
        speedBackspace = 5; //Backspace Speed


    function typeWriter(id, ar, isBackspacing=false) {
      var element = $("#" + id),
          aString = ar[a],
          eParagraph = element.children("p"); //Subheader element

      // Determine if animation should be typing or backspacing
      if (!isBackspacing) {

        // If full string hasn't yet been typed out, continue typing
        if (i < aString.length) {
          if (aString.charAt(i) == ".") {
            eParagraph.text(eParagraph.text() + aString.charAt(i));
            i++;
            setTimeout(function(){ typeWriter(id, ar); }, speedBetweenLines);
          } else {

            eParagraph.text(eParagraph.text() + aString.charAt(i));
            i++;
            setTimeout(function(){ typeWriter(id, ar); }, speedForward);

          }

        // If full string has been typed
        } else if (i == aString.length) {

          // full string typed.
          console.info("finsihed typing");

          // TODO show insert and rehint button.

          // isBackspacing = true;
          // setTimeout(function(){ typeWriter(id, ar); }, speedWait);

        }

      // If backspacing is enabled
      } else {

        // If still has text, continue backspacing
        if (eParagraph.text().length > 0) {
          eParagraph.text(eParagraph.text().substring(0, eParagraph.text().length - 1));
          setTimeout(function(){ typeWriter(id, ar, true); }, speedBackspace);

        // If no text, complete.
        } else {

          i = 0;
          // a = (a + 1) % ar.length; //Moves to next position in array, always looping back to 0
          console.info("finsihed deleting");
          // setTimeout(function(){ typeWriter(id, ar); }, 50);

        }
      }
    }
    </script>

    <script>
      /**
       * On document load, two buttons that the user can click on
       */

      $(function() {
        console.log('entering button functions');
        $('#run-hint').click(hintText);
        $('#insert-text').click(insertText);
        console.log('exiting button functions');
      });

      /**
       * Runs a server-side function to fetch text based on user inputs
       * the sidebar UI with the resulting text.
       */
      function hintText() {
        hideError();
        gtag( 'event' , 'query', { 'event_category' : 'engagement', method : 'hint-sidebar' });
        typeWriter("output", [], true);
        console.log('entering hintText');
        this.disabled = true;
        $('#error').remove();
        var originalText = $('input[name=origin]').val();
        google.script.run
            .withSuccessHandler(
              function( response , element )
              {
                typeWriter("output", [response.suggestion]);
                $('input[name=originalText]').val(response.suggestion);
                console.info(response.suggestion)


                element.disabled = false;
              })
            .withFailureHandler(
              function(msg, element) {
                logError(msg, true);
                element.disabled = false;
                displayError();
              })
             .withUserObject(this)
             .getTextandGiveHint();
        console.log('exiting hintText');
      }

      /**
       * Runs a server-side function to insert the fetched text into the document
       * at the user's cursor or selection.
       */
      function insertText() {
        hideError();
        gtag('event', 'insert', { 'event_category' : 'engagement', method : 'hint-sidebar'});
        console.log('entering insertText');
        //var originalText = $('input[name=origin]').val();
        this.disabled = true;
        typeWriter("output", [], true);
          google.script.run
            .withSuccessHandler(
              function(returnSuccess, element) {
                element.disabled = false;
                //$('#textSuggestion').val(returnSuccess.suggestion);
                //$('input[name=originalText]').val(returnSuccess.suggestion);
              })
            .withFailureHandler(
              function(msg, element) {
                logError(msg, true);
                displayError();
                element.disabled = false;
              })
            .withUserObject(this)
            .insertText($('#output').text())
            .getTextandGiveHint();

        $('#error').remove();

            console.log('exiting insertText');
      }

      /**
       * Inserts a div that contains an error message after a given element.
       *
       * @param {string} msg The error message to display.
       * @param {DOMElement} element The element after which to display the error.
       */
      function logError(msg, fatal) {
        gtag('event', 'exception', { 'description': msg, 'fatal' : fatal});
      }
      function displayError(){
        var div = $('<div class="alert alert-warning" role="alert"><strong>Oops!</strong><br/>Seems like something didn\'t quite work out. Contact <strong>hello@hintwriting.com</strong> for support!</div>');
        $('#error-bay').html(div);
        $('#error-bay').show("slow");
      }
      function hideError(){
        $('#error-bay').hide("fast");
      }
    </script>
  </body>
</html>
